<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loading...</title>
    <link rel="stylesheet" href="/assets/mobile.css">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
      mermaid.initialize({ 
        startOnLoad: false,
        theme: 'default',
        securityLevel: 'loose',
      });
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #f0f4f8;
        color: #1e293b;
      }

      /* Header */
      header {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: white;
        padding: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 2rem;
      }

      .header-image {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #0ea5e9, #06b6d4);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: bold;
      }

      .header-text h1 {
        font-size: 1.8rem;
        margin-bottom: 0.3rem;
      }

      .header-text p {
        color: #94a3b8;
        font-size: 1rem;
      }

      .header-links {
        display: flex;
        gap: 1.5rem;
      }

      .header-links a {
        color: white;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border: 1px solid #38bdf8;
        border-radius: 4px;
        transition: all 0.3s;
      }

      .header-links a:hover {
        background: #38bdf8;
      }

      /* Main Layout */
      .container {
        display: flex;
        min-height: calc(100vh - 180px);
      }

      /* Sidebar Navigation */
      nav {
        width: 250px;
        background: #0f172a;
        padding: 2rem 0;
      }

      nav ul {
        list-style: none;
      }

      nav li {
        margin: 0;
      }

      nav a {
        display: block;
        color: #94a3b8;
        text-decoration: none;
        padding: 1rem 2rem;
        transition: all 0.3s;
        border-left: 3px solid transparent;
      }

      nav a:hover,
      nav a.active {
        background: #1e293b;
        color: #38bdf8;
        border-left-color: #0284c7;
      }

      /* Main Content */
      main {
        flex: 1;
        padding: 3rem;
      }

      .content-section {
        display: none;
        animation: fadeIn 0.3s;
      }

      .content-section.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      h2 {
        color: #0f172a;
        font-size: 2rem;
        margin-bottom: 1.5rem;
        border-bottom: 3px solid #0284c7;
        padding-bottom: 0.5rem;
      }

      .experience-item,
      .project-item {
        background: white;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #0284c7;
      }

      .experience-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
      }

      .experience-header h3 {
        color: #0f172a;
        font-size: 1.3rem;
      }

      .experience-header .date {
        color: #64748b;
        font-size: 0.9rem;
      }

      .company {
        color: #0284c7;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .description {
        color: #475569;
        line-height: 1.6;
        margin-bottom: 1rem;
      }

      .highlights {
        list-style: none;
        padding-left: 0;
      }

      .highlights li {
        padding-left: 1.5rem;
        margin-bottom: 0.5rem;
        position: relative;
        color: #475569;
        line-height: 1.5;
      }

      .highlights li:before {
        content: "▹";
        position: absolute;
        left: 0;
        color: #0284c7;
        font-weight: bold;
      }

      .skills-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
      }

      .skill-category {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .skill-category h3 {
        color: #0284c7;
        margin-bottom: 1rem;
      }

      .skill-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .skill-tag {
        background: #e0f2fe;
        color: #0369a1;
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-size: 0.9rem;
      }

      /* Contact Form */
      .contact-form {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        max-width: 600px;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #0f172a;
        font-weight: 500;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid #cbd5e1;
        border-radius: 4px;
        font-family: inherit;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 120px;
      }

      button[type="submit"] {
        background: #0ea5e9;
        color: white;
        padding: 0.8rem 2rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: background 0.3s;
      }

      button[type="submit"]:hover {
        background: #0284c7;
      }

      /* Architecture Diagrams */
      .architecture-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 2rem;
      }

      .architecture-card {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .architecture-card h3 {
        color: #0284c7;
        margin-bottom: 1rem;
      }

      .architecture-card ul {
        list-style: none;
        padding: 0;
      }

      .architecture-card li {
        padding: 0.5rem 0;
        padding-left: 1.5rem;
        position: relative;
        color: #475569;
      }

      .architecture-card li:before {
        content: "→";
        position: absolute;
        left: 0;
        color: #0284c7;
      }

      /* Footer */
      footer {
        background: #0f172a;
        color: #94a3b8;
        padding: 2rem;
        text-align: center;
      }

      footer a {
        color: #38bdf8;
        text-decoration: underline !important;
        text-decoration-thickness: 2px !important;
        text-underline-offset: 3px !important;
      }

      footer a:hover {
        text-decoration: underline;
      }

      .loading {
        text-align: center;
        color: #64748b;
        padding: 2rem;
      }

      .error {
        background: #fee;
        color: #c00;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-left">
        <img src="/assets/profile.png" alt="Profile" class="header-image" id="header-photo">
        <div class="header-text">
          <h1 id="header-name">Loading...</h1>
          <p id="header-title">Loading...</p>
        </div>
      </div>
      <div class="header-links">
        <a href="#" id="pdf-link" target="_blank">Resume (PDF)</a>
        <a href="#" id="linkedin-link" target="_blank">LinkedIn</a>
        <a href="#" id="github-link" target="_blank">GitHub</a>
      </div>
    </header>

    <div class="container">
      <nav>
        <ul>
          <li>
            <a href="#about" class="nav-link active" data-section="about"
              >About Me</a
            >
          </li>
          <li>
            <a href="#experience" class="nav-link" data-section="experience"
              >Experience</a
            >
          </li>
          <li>
            <a href="#skills" class="nav-link" data-section="skills">Skills</a>
          </li>
          <li>
            <a href="#education" class="nav-link" data-section="education"
              >Education</a
            >
          </li>
          <!-- <li>
            <a href="#projects" class="nav-link" data-section="projects"
              >Projects</a
            > -->
          </li>
          <li>
            <a href="#architecture" class="nav-link" data-section="architecture"
              >Architecture</a
            >
          </li>
          <li>
            <a href="#contact" class="nav-link" data-section="contact"
              >Contact</a
            >
          </li>
        </ul>
      </nav>

      <main>
        <!-- About Section -->
        <section id="about" class="content-section active">
          <h2>About Me</h2>
          <div class="loading">Loading profile...</div>
        </section>

        <!-- Experience Section -->
        <section id="experience" class="content-section">
          <h2>Experience</h2>
          <div class="loading">Loading experience...</div>
        </section>

        <!-- Skills Section -->
        <section id="skills" class="content-section">
          <h2>Skills</h2>
          <div class="loading">Loading skills...</div>
        </section>

        <!-- Education Section -->
        <section id="education" class="content-section">
          <h2>Education</h2>
          <div class="loading">Loading education...</div>
        </section>

        <!-- Projects Section -->
        <section id="projects" class="content-section">
          <h2>Projects</h2>
          <div class="loading">Loading projects...</div>
        </section>

        <!-- Architecture Section -->
        <section id="architecture" class="content-section">
          <h2>System Architecture</h2>
          <p style="color: #475569; margin-bottom: 2rem; line-height: 1.6">
            This serverless resume website leverages AWS services for a scalable, cost-effective solution with unified code deployment across local and production environments.  The diagram below is rendered using Mermaid.js. 
          </p>
          
          <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow-x: auto;">
            <div id="architecture-diagram">
              Loading diagram...
            </div>
          </div>

          <div style="background: white; padding: 2rem; margin-top: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="color: #0284c7; margin-bottom: 1rem;">Architecture Highlights</h3>
            
            <div style="margin-bottom: 1.5rem;">
              <h4 style="color: #0f172a; margin-bottom: 0.5rem;">Production Environment</h4>
              <ul style="color: #475569; line-height: 1.8;">
                <li><strong>CloudFront CDN:</strong> Global content delivery for static assets and API routing</li>
                <li><strong>S3:</strong> Static file storage (HTML, CSS, JavaScript, images)</li>
                <li><strong>API Gateway:</strong> RESTful API endpoint management</li>
                <li><strong>Lambda:</strong> Serverless compute running FastAPI with Mangum adapter</li>
                <li><strong>DynamoDB:</strong> NoSQL database for resume data (profile, experience, education, skills)</li>
              </ul>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
              <h4 style="color: #0f172a; margin-bottom: 0.5rem;">Local Development</h4>
              <ul style="color: #475569; line-height: 1.8;">
                <li><strong>Docker Compose:</strong> Multi-container orchestration</li>
                <li><strong>Nginx:</strong> Reverse proxy handling static files and API routing</li>
                <li><strong>FastAPI:</strong> Same Python code as production</li>
                <li><strong>LocalStack:</strong> Local AWS service simulation</li>
              </ul>
            </div>
            
            <div>
              <h4 style="color: #0f172a; margin-bottom: 0.5rem;">Key Features</h4>
              <ul style="color: #475569; line-height: 1.8;">
                <li><strong>Unified Codebase:</strong> Mangum adapter enables identical FastAPI code in Lambda and Docker</li>
                <li><strong>Excel-Based CMS:</strong> Non-technical content updates via spreadsheet templates</li>
                <li><strong>Security:</strong> Google reCAPTCHA v2 and rate limiting on contact forms</li>
                <li><strong>CI/CD:</strong> GitHub Actions with Terraform for infrastructure as code (planned)</li>
                <li><strong>Quality Assurance:</strong> Pre-commit hooks with pytest unit tests</li>
              </ul>
            </div>
          </div>
        </section>

        <!-- Contact Section -->
        <section id="contact" class="content-section">
          <h2>Contact</h2>
          <div class="contact-form">
            <form id="contact-form">
              <div class="form-group">
                <label for="name">Name</label>
                <input type="text" id="name" name="name" required />
              </div>
              <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required />
              </div>
              <div class="form-group">
                <label for="message">Message</label>
                <textarea id="message" name="message" required></textarea>
              </div>
              <div class="g-recaptcha" data-sitekey="6LdFbkgsAAAAAIGnih96mwniw6bnH-unwaFTkYgR"></div>
              <button type="submit">Send Message</button>
            </form>
          </div>
        </section>
      </main>
    </div>

    <footer>
      <p>
        Built with AWS (Lambda, API Gateway, DynamoDB, S3, CloudFront) •
        Deployed via Terraform
      </p>
      <p>
        Frontend design assisted by AI •
        <a
          href="https://github.com/mr-flowjangles/aws-serverless-resume"
          target="_blank"
          >View source on GitHub</a
        >
      </p>
    </footer>

    <script>
      // Navigation
      const navLinks = document.querySelectorAll(".nav-link");
      const sections = document.querySelectorAll(".content-section");

      function showSection(sectionId) {
        // On mobile, show all sections (handled by CSS)
        // On desktop, show only selected section
        const isMobile = window.innerWidth <= 768;
        
        if (!isMobile) {
          sections.forEach((s) => s.classList.remove("active"));
          navLinks.forEach((l) => l.classList.remove("active"));

          const section = document.getElementById(sectionId);
          const link = document.querySelector(`[data-section="${sectionId}"]`);

          if (section) section.classList.add("active");
          if (link) link.classList.add("active");
        }

        // Load data if not already loaded
        loadSectionData(sectionId);
      }

      navLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const section = link.dataset.section;
          showSection(section);
        });
      });

      // API calls
      const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
        ? "/api" 
        : "https://qehzqmqmwg.execute-api.us-east-1.amazonaws.com/prod/api";

      async function loadSectionData(section) {
        const container = document.getElementById(section);

      try {
        const h2 = container.querySelector('h2');
        const h2Text = h2 ? h2.textContent : '';
        
        switch (section) {
          case "about":
            await loadProfile(container);
            break;
          case "experience":
            await loadExperience(container);
            break;
          case "skills":
            await loadSkills(container);
            break;
          case "education":
            await loadEducation(container);
            break;
          case "projects":
            await loadProjects(container);
            break;
          case "architecture":
            await loadArchitecture();
            break;
        }
        
        // Re-add h2 if it existed and was removed
        if (h2Text && !container.querySelector('h2')) {
          const newH2 = document.createElement('h2');
          newH2.textContent = h2Text;
          container.insertBefore(newH2, container.firstChild);
        }
      } catch (error) {
          container.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
        }
      }

      async function loadProfile(container) {
        const response = await fetch(`${API_BASE}/resume/profile`);
        const data = await response.json();

        container.innerHTML = `
          <div class="experience-item">
            <h3>${data.name}</h3>
            <p class="company">${data.title}</p>
            <p class="description">${data.summary}</p>
            <p><strong>Location:</strong> ${data.location}</p>
            ${data.email ? `<p><strong>Email:</strong> ${data.email}</p>` : ''}
          </div>
          ${
            data.professional_summary
              ? `
            <div class="experience-item" style="margin-top: 1.5rem;">
              <h3>Professional Summary</h3>
              <p class="description">${data.professional_summary}</p>
            </div>
          `
              : ""
          }
        `;
      }

      async function loadExperience(container) {
        const response = await fetch(`${API_BASE}/resume/work-experience`);
        const data = await response.json();

        let html = "";
        data.items.forEach((exp) => {
          const endDate = exp.is_current ? "present" : exp.end_date;
          html += `
                    <div class="experience-item">
                        <div class="experience-header">
                            <div>
                                <h3>${exp.job_title}</h3>
                                <p class="company">${exp.company_name}</p>
                            </div>
                            <span class="date">${
                              exp.start_date
                            } – ${endDate}</span>
                        </div>
                        <p class="description">${exp.description}</p>
                        <ul class="highlights">
                            ${exp.accomplishments
                              .map((h) => `<li>${h}</li>`)
                              .join("")}
                        </ul>
                    </div>
                `;
        });

        container.innerHTML = html;
      }

      async function loadSkills(container) {
        const response = await fetch(`${API_BASE}/resume/skills`);
        const data = await response.json();

        let html = '<div class="skills-grid">';
        data.items.forEach((skillItem) => {
          html += `
                    <div class="skill-category">
                        <h3>${skillItem.category}</h3>
                        <div class="skill-tags">
                            ${skillItem.skills
                              .map((s) => `<span class="skill-tag">${s}</span>`)
                              .join("")}
                        </div>
                    </div>
                `;
        });
        html += "</div>";

        container.innerHTML = html;
      }

      async function loadEducation(container) {
        const response = await fetch(`${API_BASE}/resume/education`);
        const data = await response.json();

      let html = "";
      data.items.forEach((edu) => {
        // Format date range with defensive checks
        let dateRange = '';
        const hasStartDate = edu.start_date && edu.start_date !== 'nan';
        const hasEndDate = edu.end_date && edu.end_date !== 'nan';

        if (hasStartDate && hasEndDate) {
          dateRange = `${edu.start_date} – ${edu.end_date}`;
        } else if (hasStartDate) {
          dateRange = edu.start_date;
        } else if (hasEndDate) {
          dateRange = edu.end_date;
        }
        // If no valid dates, dateRange stays empty string

        html += `
                  <div class="experience-item">
                      <div class="experience-header">
                          <div>
                              <h3>${edu.degree}</h3>
                              <p class="company">${edu.institution}</p>
                          </div>
                          ${dateRange ? `<span class="date">${dateRange}</span>` : ''}
                      </div>
                      ${
                        edu.description
                          ? `<p class="description">${edu.description}</p>`
                          : ""
                      }
                  </div>
              `;
      });

        container.innerHTML = html;
      }

      async function loadProjects(container) {
        const response = await fetch(`${API_BASE}/resume/projects`);
        const data = await response.json();

        let html = "";
        data.items.forEach((proj) => {
          html += `
                    <div class="project-item">
                        <h3>${proj.name}</h3>
                        <p class="description">${proj.description}</p>
                        <div class="skill-tags">
                            ${proj.tech
                              .map((t) => `<span class="skill-tag">${t}</span>`)
                              .join("")}
                        </div>
                        <p style="margin-top: 1rem;">
                            ${
                              proj.github
                                ? `<a href="${proj.github}" target="_blank">GitHub</a>`
                                : ""
                            }
                            ${
                              proj.liveUrl
                                ? `<a href="${proj.liveUrl}" target="_blank">Live Demo</a>`
                                : ""
                            }
                        </p>
                    </div>
                `;
        });

        container.innerHTML = html;
      }

      async function loadArchitecture() {
        const diagramContainer = document.getElementById('architecture-diagram');
        
        // Check if already loaded
        if (diagramContainer.dataset.loaded === 'true') {
          return;
        }
        
        try {
          // Fetch the mermaid file
          const response = await fetch('/architecture.mermaid');
          if (!response.ok) {
            throw new Error('Failed to load architecture diagram');
          }
          
          const diagramCode = await response.text();
          
          // Create a unique ID for this diagram
          const diagramId = 'mermaid-diagram-' + Date.now();
          
          // Render the diagram using mermaid
          const { svg } = await mermaid.render(diagramId, diagramCode);
          
          // Insert the rendered SVG
          diagramContainer.innerHTML = svg;
          
          // Mark as loaded
          diagramContainer.dataset.loaded = 'true';
        } catch (error) {
          console.error('Mermaid rendering error:', error);
          diagramContainer.innerHTML = `<div style="color: #ef4444; padding: 1rem;">Error loading diagram: ${error.message}</div>`;
        }
      }

      // Contact form
      document
        .getElementById("contact-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const recaptchaResponse = grecaptcha.getResponse();
          if (!recaptchaResponse) {
            alert("Please complete the reCAPTCHA");
            return;
          }

          const formData = {
            name: document.getElementById("name").value,
            email: document.getElementById("email").value,
            message: document.getElementById("message").value,
            recaptcha_token: recaptchaResponse,
          };

          try {
            const response = await fetch(`${API_BASE}/contact`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(formData),
            });

            if (response.ok) {
              alert("Message sent successfully!");
              e.target.reset();
            } else {
              alert("Failed to send message. Please try again.");
            }
          } catch (error) {
            alert("Error sending message: " + error.message);
          }
        });

      // Load initial section
      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        // Load all sections for mobile vertical scroll
        loadSectionData("about");
        loadSectionData("experience");
        loadSectionData("skills");
        loadSectionData("education");
        loadSectionData("projects");
        loadSectionData("architecture");
      } else {
        // Desktop - load only about section
        loadSectionData("about");
      }

      // On mobile, collapse all sections except About Me
      if (isMobile) {
        setTimeout(() => {
          document.querySelectorAll('.content-section').forEach(section => {
            if (section.id !== 'about') {
              section.classList.add('collapsed');
            }
          });
        }, 500);
      }

      // Load header data
      async function loadHeaderData() {
        try {
          const response = await fetch(`${API_BASE}/resume/profile`);
          const data = await response.json();

          // Update page title
          document.title = `${data.name} - ${data.title}`;

          // Update header with profile data
          document.getElementById("header-name").textContent = data.name;
          document.getElementById("header-title").textContent = data.title;

          // Update initials in header image
          document.getElementById("header-photo").src = data.photo;

          // Update PDF link
          document.getElementById("pdf-link").href = data.resume_pdf;
          document.getElementById("linkedin-link").href = data.linkedin;
          document.getElementById("github-link").href = data.github;
        } catch (error) {
          console.error("Error loading header:", error);
        }
      }

      loadHeaderData();

      // Collapsible sections on mobile (using event delegation)
      if (window.innerWidth <= 768) {
        document.addEventListener('click', function(e) {
          if (e.target.tagName === 'H2' && e.target.closest('.content-section')) {
            e.target.parentElement.classList.toggle('collapsed');
          }
        });
      }
    </script>
  </body>
</html>